<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>动态表格</title>
    <script src="./jquery.min.js"></script>
    <script src="./config.js"></script>
    <style>
        table{
            border: 1px solid;
            margin: auto;
            width: 1000px;
        }
        td,th{
            text-align: center;
            border: 1px solid;
        }
        div{
            text-align: center;
            margin: 50px;
        }
    </style>
</head>
<body>
<table class="info">
    <tr>
        <td>当前是第</td>
        <td>0</td>
        <td>页</td>
        <td><button onclick="reqnext(initno=undefined, neg=1, refresh=undefined)">上一页</button></td>
        <td><button onclick="reqnext()">下一页</button></td>
        <td><button onclick="reqnext(initno=undefined, neg=0, refresh=1)">刷新</button></td>
        <td><input value="100" class="pageno" onchange="reqnext(initno=0, neg=undefined, refresh=1)"></td>
        <td>
            <div>
                范围: <input type="text" name="range" id="range" value="(1, 3)">
                <input type="submit" value="导出" id="export" onclick="export_xls(document.getElementById('range').value)">
                <input type="submit" value="删除" id="delete" onclick="delete_ids(document.getElementById('range').value)">
            </div>
        </td>
    </tr>
</table>

<table id = "main">
    <!-- 表格标题 -->
    <caption>记录表</caption>
    <!-- 表格第一行：表格表头 -->
    
</table>

<table class="info">
    <tr>
        <td>当前是第</td>
        <td>0</td>
        <td>页</td>
        <td><button onclick="reqnext(initno=undefined, neg=1, refresh=undefined)">上一页</button></td>
        <td><button onclick="reqnext()">下一页</button></td>
        <td><button onclick="reqnext(initno=undefined, neg=0, refresh=1)">刷新</button></td>
        <td><input value="100" class="pageno" onchange="reqnext(initno=0, neg=undefined, refresh=1)" readonly></td>
        <td>
            <div>
                范围: <input type="text" name="range" id="range2" value="(1, 3)">
                <input type="submit" value="导出" id="export2" onclick="export_xls(document.getElementById('range2').value)">
                <input type="submit" value="删除" id="delete2" onclick="delete_ids(document.getElementById('range2').value)">
            </div>
        </td>
    </tr>
</table>
<script>
    function export_xls(range){
        obj = {
            "range": range,
            "c": db_info
        };
        $.ajax({
            type:"post",
            url:export_link,
            data:JSON.stringify(obj),
            dataType:'json',
            success:function(result){
                alert("导出成功")
            },
            error:function(result){
                alert(result);
            }
        });
    }

    function delete_ids(range){
        obj = {
            "range": range,
            "c": db_info
        };
        $.ajax({
            type:"post",
            url:delete_link,
            data:JSON.stringify(obj),
            dataType:'json',
            success:function(result){
                if(result["data"] == "True"){
                    alert("删除成功")
                    reqnext(initno=undefined, neg=0, refresh=1)
                }
                else{
                    alert("删除失败，注意范围是左闭右开的集合，即输入(1,2),会报错，应该输入(1,3),如果删除单个值，需要使用(1)")
                }
            },
            error:function(result){
                alert(result);
            }
        });
    }
    function reqnext(initno, neg, refresh){
        function getElementByClassName(classnames){ 
            var objArray= new Array();//定义返回对象数组
            var tags=document.getElementsByTagName("*");//获取页面所有元素
            var index = 0;
            for(var i in tags){
                if(tags[i].nodeType==1){
                    if(tags[i].getAttribute("class") == classnames){ //如果某元素的class值为所需要
                        objArray[index]=tags[i];
                        index++;
                    } 
                } 
            } 
            return objArray;
        }
        pageno = 0
        if (typeof(initno) == "undefined"){
            pageno = getElementByClassName("info")[0].firstElementChild.firstElementChild.children[1].innerHTML;
            pageno = parseInt(pageno, 10);
            if(neg == 1){
                pageno = pageno - 1
            }
            else if(refresh == 1){
                pageno = pageno
            }
            else{
                pageno = pageno + 1
            }
        }
        else{
            pageno = initno
        }
        pages = getElementByClassName("pageno")
        for(i=0; i<pages.length; ++i){
            pages[i].value = pages[0].value
        }
        obj = {
            "c": db_info,
            "page":parseInt(pages[0].value),
            "no":pageno
        }
        $.ajax({
            type:"post",
            url:change_page_link,
            data:JSON.stringify(obj),
            dataType:'json',
            success:function(result){
                pre = "<tr><th>op</th><th>id</th><th>file_execute</th><th>execute_time</th><th>finish_time</th><th>result</th><th>args</th><th>other</th><th>default1</th><th>default2</th><th>default3</th><th>default4</th><th>delete_flag</th></tr>"
                var table = document.getElementById("main");
                sum_tr = ""
                for(var i =0; i < result["data"].length; i++){
                    result["data"][i]
                    tr = "<tr>"
                    tr = tr + "<td><a href=\"javascript:void(0);\" onclick=\"deleteTr(this)\" >删除</a></td>"
                    for(var j = 0; j < result["data"][i].length; ++j){
                        tr = tr + "<td>" + result["data"][i][j] + "</td>"
                    }
                    tr = tr + "</tr>"
                    tr = tr + "\n"
                    sum_tr = sum_tr + tr
                }
                table.innerHTML = pre + sum_tr
            },
            error:function(result){
                alert(result);
            }
        });
        for(var i = 0; i < getElementByClassName("info").length; ++i){
            getElementByClassName("info")[i].firstElementChild.firstElementChild.children[1].innerHTML = pageno
        }
    }

    function deleteTr(object) {
        var id = object.parentNode.parentNode.children[1].innerHTML;
        delete_ids("[" + id + ", " + id + "]");
    }
    $(document).ready(function(){ 
        reqnext(init=0)
    });
</script>
</body>
</html>
